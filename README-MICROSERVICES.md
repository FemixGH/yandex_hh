# Микросервисная архитектура ИИ Бармена

## Обзор архитектуры

Проект разделен на 6 независимых микросервисов, объединенных единым Gateway API:

```
┌─────────────────┐
│   Nginx Proxy   │ ← Внешний трафик
└─────────────────┘
         │
┌─────────────────┐
│  Gateway API    │ ← Единая точка входа
│     :8000       │
└─────────────────┘
         │
    ┌────┴────┬────────┬──────────┬──────────┐
    │         │        │          │          │
┌───▼───┐ ┌──▼──┐ ┌───▼────┐ ┌──▼────┐ ┌──▼────┐
│Telegram│ │ RAG │ │Validation│ │Yandex │ │Logging│
│ :8001  │ │:8002│ │  :8003   │ │ :8004 │ │ :8005 │
└────────┘ └─────┘ └──────────┘ └───────┘ └───────┘
```

## Микросервисы

### 1. Gateway Service (:8000)
**Назначение:** Единая точка входа, маршрутизация запросов
- Объединяет все сервисы
- Обрабатывает основную бизнес-логику
- Проксирует запросы к другим сервисам
- Мониторинг здоровья системы

**Основные эндпоинты:**
- `POST /bartender/ask` - главный эндпоинт для общения с ИИ
- `GET /health` - статус всей системы
- `/telegram/*` - проксирование к Telegram сервису
- `/rag/*` - проксирование к RAG сервису

### 2. Telegram Bot Service (:8001)
**Назначение:** Обработка сообщений Telegram бота
- Получение и обработка сообщений из Telegram
- Форматирование ответов для Telegram
- Управление состоянием пользователей
- Интеграция с Gateway через HTTP

**Особенности:**
- Асинхронный Telegram бот
- Markdown форматирование
- Обработка длинных сообщений
- Кнопки быстрого доступа

### 3. RAG Service (:8002)
**Назначение:** Векторный поиск и генерация ответов
- Загрузка и кеширование векторного индекса
- Семантический поиск по документам
- Генерация ответов с контекстом
- Управление индексом (пересборка, обновление)

**Основные функции:**
- `POST /answer` - генерация ответа с RAG
- `POST /search` - семантический поиск
- `GET /index/status` - статус индекса
- `POST /index/rebuild` - пересборка индекса

### 4. Validation Service (:8003)
**Назначение:** Валидация и модерация контента
- Модерация входящих запросов
- Модерация исходящих ответов
- Валидация текста (длина, спам, релевантность)
- Предложения по улучшению запросов

**Типы проверок:**
- Базовая валидация текста
- Специальная валидация коктейльных запросов
- Модерация через Yandex API
- Комбинированная проверка

### 5. Yandex API Service (:8004)
**Назначение:** Взаимодействие с API Яндекса
- Генерация текста через YandexGPT
- Создание эмбеддингов
- Пакетное создание эмбеддингов
- Кеширование и статистика запросов

**Возможности:**
- `POST /completion` - генерация текста
- `POST /embedding` - создание эмбеддинга
- `POST /batch_embedding` - пакетные эмбеддинги
- `GET /stats` - статистика использования

### 6. Logging Service (:8005)
**Назначение:** Централизованное логирование
- Сбор логов от всех сервисов
- Хранение в памяти (для продакшена - БД)
- Поиск и фильтрация логов
- Экспорт логов в разных форматах

**Функции:**
- `POST /log` - добавление записи
- `POST /query` - поиск логов
- `GET /stats` - статистика логирования
- `GET /export` - экспорт логов

## Установка и запуск

### Требования
- Docker и Docker Compose
- Windows 11
- Минимум 4GB RAM
- Настроенные переменные окружения

### Быстрый старт (Windows)

1. **Настройка переменных окружения:**
```cmd
copy .env.microservices .env
REM Отредактируйте .env файл, заполните API ключи
```

2. **Запуск всей системы:**
```cmd
start-microservices.bat
```

3. **Проверка статуса:**
```cmd
monitor-microservices.bat
```

4. **Остановка:**
```cmd
stop-microservices.bat
```

### Ручной запуск
```cmd
docker-compose -f docker-compose.microservices.yml up -d
```

## Доступные порты

- **8000** - Gateway API (основной)
- **8001** - Telegram Bot Service
- **8002** - RAG Service
- **8003** - Validation Service  
- **8004** - Yandex API Service
- **8005** - Logging Service
- **80** - Nginx (если включен)

## Мониторинг

### Проверка здоровья
```cmd
curl http://localhost:8000/health
```

### Логи сервисов
```cmd
docker-compose -f docker-compose.microservices.yml logs -f [service_name]
```

### Статистика ресурсов
```cmd
docker stats
```

## API Документация

После запуска системы доступна по адресам:
- **Swagger UI:** http://localhost:8000/docs
- **ReDoc:** http://localhost:8000/redoc

## Масштабирование

### Горизонтальное масштабирование
```bash
docker-compose -f docker-compose.microservices.yml up -d --scale rag=3 --scale yandex=2
```

### Вертикальное масштабирование
Отредактируйте docker-compose.yml, добавьте:
```yaml
deploy:
  resources:
    limits:
      cpus: '2.0'
      memory: 2G
```

## Безопасность

- Все межсервисные коммуникации по HTTP внутри Docker сети
- Nginx для rate limiting
- Модерация контента через отдельный сервис
- Логирование всех операций

## Производство

Для продакшена рекомендуется:
1. Заменить in-memory хранилище логов на PostgreSQL
2. Добавить Redis для кеширования
3. Настроить HTTPS в Nginx
4. Использовать внешние системы логирования (ELK stack)
5. Добавить мониторинг (Prometheus + Grafana)

## Разработка

### Разработка отдельного сервиса
```cmd
cd services\[service_name]
python main.py
```

### Перестройка конкретного сервиса
```cmd
docker-compose -f docker-compose.microservices.yml build [service_name]
docker-compose -f docker-compose.microservices.yml up -d [service_name]
```

## Troubleshooting

### Сервис не запускается
1. Проверьте логи: `docker-compose -f docker-compose.microservices.yml logs [service_name]`
2. Проверьте переменные окружения в .env
3. Убедитесь, что порты не заняты: `netstat -an | findstr :8000`

### Медленная работа RAG
1. Увеличьте ресурсы для RAG сервиса
2. Проверьте размер векторного индекса
3. Рассмотрите кеширование запросов

### Проблемы с модерацией
1. Проверьте Yandex API ключи
2. Проверьте квоты API
3. Посмотрите логи Validation сервиса
